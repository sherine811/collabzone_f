name: Deploy Campus Portal to AKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: campus-portal-rg
  AZURE_CONTAINER_REGISTRY: campusportalacr
  AZURE_KUBERNETES_CLUSTER: campus-portal-aks
  IMAGE_NAME: campusportalacr.azurecr.io/campus_portal_site

jobs:
  provision-infra:
    runs-on: ubuntu-latest
    outputs:
      acr-login-server: ${{ steps.acr.outputs.loginServer }}
      aks-name: ${{ steps.aks.outputs.name }}
      resource-group: ${{ steps.rg.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform_aks
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform_aks
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: terraform_aks
        run: terraform apply -auto-approve tfplan

      - name: Get ACR Login Server
        id: acr
        run: echo "loginServer=$(az acr show --name ${{ env.AZURE_CONTAINER_REGISTRY }} --query loginServer -o tsv)" >> $GITHUB_OUTPUT

      - name: Get AKS Name
        id: aks
        run: echo "name=${{ env.AZURE_KUBERNETES_CLUSTER }}" >> $GITHUB_OUTPUT

      - name: Get Resource Group
        id: rg
        run: echo "name=${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: provision-infra
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Build Docker Image
        working-directory: campus_portal_site
        run: docker build -t ${{ env.IMAGE_NAME }}:latest .

      - name: Push Docker Image
        run: docker push ${{ env.IMAGE_NAME }}:latest

  deploy:
    needs: [provision-infra, build-and-push]
    runs-on: ubuntu-latest
    outputs:
      external-ip: ${{ steps.get-ip.outputs.ip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        run: az aks get-credentials --resource-group ${{ needs.provision-infra.outputs.resource-group }} --name ${{ needs.provision-infra.outputs.aks-name }}

      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible

      - name: Run Ansible Playbook
        working-directory: ansible
        run: ansible-playbook playbook.yaml

      - name: Wait for External IP
        run: |
          echo "Waiting for external IP..."
          for i in {1..30}; do
            IP=$(kubectl get svc campusportal-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$IP" ]; then
              echo "External IP: $IP"
              echo "ip=$IP" >> $GITHUB_OUTPUT
              break
            fi
            sleep 10
          done
        id: get-ip

      - name: Display External IP
        run: echo "Campus Portal is accessible at: http://${{ steps.get-ip.outputs.ip }}"
